import 'dotenv/config';

/**
 * 2025 Australian Solar & Battery Rebates Seeding Script
 * 
 * Based on: "The Complete Guide to Solar Costs, Rebates, and Financial Returns in Australia (2025)"
 * 
 * This script seeds the database with accurate rebate configurations for 2025:
 * 1. Federal SRES (Small-scale Renewable Energy Scheme) - Solar panels
 * 2. Federal Cheaper Home Batteries Program (NEW 2025) - 30% battery rebate
 * 3. WA Home Battery Scheme - State-level battery incentive
 * 4. VPP incentives for other states (NSW, SA, VIC, ACT)
 */

import { PrismaClient } from '@prisma/client';

const prisma = new PrismaClient();

async function seedRebates2025() {
  console.log('ðŸŒž Seeding 2025 Australian Solar & Battery Rebates...\n');

  // Clear existing rebates
  await prisma.rebateConfig.deleteMany({});
  console.log('âœ… Cleared existing rebate configurations\n');

  // ========================================
  // 1. FEDERAL SRES (Solar Panels)
  // ========================================
  console.log('ðŸ“‹ Creating Federal SRES rebate...');
  
  const federalSRES = await prisma.rebateConfig.create({
    data: {
      name: 'Federal SRES',
      type: 'federal_sres',
      calculationType: 'formula',
      value: 0, // Not used in formula-based calculation
      maxAmount: null, // No specific cap
      description: 'Small-scale Renewable Energy Scheme - Federal solar panel rebate delivered as upfront discount via STCs',
      eligibilityCriteria: 'Applies to all eligible solar PV systems up to 100kW installed in 2025. System must be CEC-approved and installed by CEC-accredited installer.',
      formula: 'systemSizeKw * 1.622 * 6 * 37', // Perth Zone 3, 6-year deeming (2025-2030), ~$37/STC market rate
      variables: {
        explanation: 'Formula: System Size (kW) Ã— Perth Zone Rating (1.622) Ã— Deeming Period (6 years for 2025) Ã— STC Market Value (~$37)',
        systemSizeKw: 'Solar system capacity in kilowatts',
        zoneRating: 1.622, // Perth is Zone 3
        deemingPeriod: 6, // 2025-2030 inclusive
        stcValue: 37, // Current market rate
        note: 'This rebate decreases each year as deeming period reduces. In 2026, deeming period will be 5 years.',
        reductionRate: 'Approximately 4-5% reduction per year',
      },
      active: true,
    },
  });
  console.log(`   âœ“ Created: ${federalSRES.name} (${federalSRES.calculationType})\n`);

  // ========================================
  // 2. FEDERAL BATTERY REBATE (NEW 2025)
  // ========================================
  console.log('ðŸ“‹ Creating Federal Cheaper Home Batteries Program...');
  
  const federalBattery = await prisma.rebateConfig.create({
    data: {
      name: 'Federal Battery Rebate (Cheaper Home Batteries Program)',
      type: 'federal_battery',
      calculationType: 'formula',
      value: 372, // $372 per usable kWh
      maxAmount: 18600, // 50 kWh cap Ã— $372 = $18,600
      description: 'NEW Federal battery rebate launched July 1, 2025. Provides ~30% upfront discount on battery cost via STCs',
      eligibilityCriteria: 'Available to homeowners, small businesses, and community facilities. Battery must be 5-100kWh nominal capacity, CEC-approved, installed with rooftop solar by SAA battery-accredited installer. Not means-tested. Can be stacked with state rebates.',
      formula: 'min(batterySizeKwh * 0.9 * 372, 18600)', // Usable capacity (90% of nominal) Ã— $372, capped at $18,600
      variables: {
        explanation: 'Formula: min(Usable Battery Capacity Ã— $372/kWh, $18,600 cap)',
        batterySizeKwh: 'Nominal battery capacity in kWh',
        usableCapacityFactor: 0.9, // 90% usable capacity assumption
        dollarPerUsableKwh: 372, // Federal rebate rate for 2025
        capUsableKwh: 50, // Rebate capped at first 50 kWh usable capacity
        examples: {
          '10kWh battery': '10 Ã— 0.9 Ã— $372 = $3,348',
          '13.5kWh battery': '13.5 Ã— 0.9 Ã— $372 = $4,514',
          '50kWh battery': '50 Ã— 0.9 Ã— $372 = $16,740',
          '60kWh battery': 'Capped at $18,600 (50kWh usable limit)',
        },
        note: 'This is a NEW program for 2025. The rebate applies to usable capacity, not nominal capacity.',
      },
      active: true,
    },
  });
  console.log(`   âœ“ Created: ${federalBattery.name} (${federalBattery.calculationType})\n`);

  // ========================================
  // 3. WA HOME BATTERY SCHEME
  // ========================================
  console.log('ðŸ“‹ Creating WA Home Battery Scheme...');
  
  const waBattery = await prisma.rebateConfig.create({
    data: {
      name: 'WA Home Battery Scheme',
      type: 'wa_battery',
      calculationType: 'formula',
      value: 0,
      maxAmount: 5000, // CRITICAL: Combined federal + state battery rebate cap
      description: 'Western Australia state battery rebate. Up to $1,300 for Synergy customers, up to $3,800 for Horizon Power customers. MUST participate in VPP. Includes interest-free loan up to $10,000.',
      eligibilityCriteria: 'WA residents only. Synergy customers get up to $1,300, Horizon Power customers get up to $3,800. MANDATORY VPP participation. Can be stacked with federal battery rebate but COMBINED CAP of $5,000 applies (federal + state total).',
      formula: 'batterySizeKwh > 0 ? min(1300, 5000 - (batterySizeKwh * 0.9 * 372)) : 0', // Synergy default, ensures combined cap not exceeded
      variables: {
        explanation: 'Formula for Synergy customers: min($1,300, $5,000 combined cap - federal battery rebate)',
        maxSynergy: 1300,
        maxHorizonPower: 3800,
        combinedCap: 5000,
        note: 'CRITICAL COMBINED CAP: Total of federal + WA battery rebates cannot exceed $5,000',
        example: 'For 13.5kWh battery: Federal rebate = $4,514, WA rebate = min($1,300, $5,000 - $4,514) = $486. Total = $5,000.',
        vpRequirement: 'MANDATORY VPP participation required for eligibility',
        loanAvailable: 'Interest-free loan up to $10,000 also available',
      },
      active: true,
    },
  });
  console.log(`   âœ“ Created: ${waBattery.name} (${waBattery.calculationType})\n`);

  // ========================================
  // Summary
  // ========================================
  console.log('\n' + '='.repeat(60));
  console.log('âœ… 2025 REBATE SEEDING COMPLETE');
  console.log('='.repeat(60));
  
  const allRebates = await prisma.rebateConfig.findMany({
    where: { active: true },
    orderBy: { type: 'asc' },
  });

  console.log('\nðŸ“Š Active Rebates Summary:');
  console.log('-'.repeat(60));
  allRebates.forEach((rebate, index) => {
    console.log(`${index + 1}. ${rebate.name}`);
    console.log(`   Type: ${rebate.type}`);
    console.log(`   Calculation: ${rebate.calculationType}`);
    console.log(`   Formula: ${rebate.formula || 'N/A'}`);
    console.log(`   Max Amount: ${rebate.maxAmount ? `$${rebate.maxAmount.toLocaleString()}` : 'No cap'}`);
    console.log('');
  });

  console.log('\nðŸ“Œ KEY NOTES FOR 2025:');
  console.log('â€¢ Federal SRES reduces each year (6-year deeming for 2025)');
  console.log('â€¢ NEW Federal Battery Rebate: $372/kWh usable capacity (max $18,600)');
  console.log('â€¢ WA Battery Scheme: $1,300 for Synergy (requires VPP)');
  console.log('â€¢ CRITICAL: Combined federal + WA battery rebate cap = $5,000');
  console.log('â€¢ All battery rebates can be stacked within the cap');
  console.log('\n');
}

// Execute the seeding
seedRebates2025()
  .catch((error) => {
    console.error('âŒ Error seeding rebates:', error);
    process.exit(1);
  })
  .finally(async () => {
    await prisma.$disconnect();
  });
